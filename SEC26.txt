
<!-- Your monitor number = 11 -->


## CIDR - Finger Method

| CIDR | NETMASK     | RIVAN Format | WILDCARD    |
| ---  | ---         | ---          | ---         |
| /20  |             | (Octet, i)   |             |
| /27  |             | (Octet, i)   |             |
| /14  |             | (Octet, i)   |             |

<br>

### Find the Network:

| Dept                 | Network               | Infected Hosts                    |
| ---                  | ---                   | ---                               |
| ADMIN                | 192.168.228.144 /18   | 192.168.228.1   - 192.168.229.254 |
| HR                   | 192.168.228.144 /21   | 192.168.224.1   - 192.168.231.254 |
| FINANCE              | 192.168.228.144 /23   | 192.168.228.129 - 192.168.228.254 |
| NOC                  | 192.168.228.144 /25   | 192.168.228.145 - 192.168.228.150 |
| SOC                  | 192.168.228.144 /29   | 192.168.192.1   - 192.168.255.254 |

<br>

### Review
__Jobs of a firewall__
1. 
2. 
3. 
4. 
5. 


<br>
<br>

---
&nbsp;


## Lab Setup

### 1. Deploy
Devices:  
- 1x CSR1000v  
- 1x NetOps  
- 1x TinyCore (yvm.ova)  


CSR1000v:
  Name: UTM-PH
  
  | NetAdapter   |        |
  | ---          | ---    |
  | NetAdapter   | NAT    |
  | NetAdapter 2 | VMNet2 |
  | NetAdapter 3 | VMNet3 |
  
  
NetOps:
  Name: NetOps-PH
  
  | NetAdapter   |                    |
  | ---          | ---                |
  | NetAdapter   | VMNet1             |
  | NetAdapter 2 | VMNet2             |
  | NetAdapter 3 | VMNet3             |
  | NetAdapter 4 | Bridge (Replicate) |


TinyCore (yvm.ova):
  Name: BLDG-PH
  
  | NetAdapter   |                    |
  | ---          | ---                |
  | NetAdapter   | VMNet3             |


<br>


### 2. Bootstrap
~~~
!@UTM-PH
conf t
 hostname UTM-PH
 enable secret pass
 service password-encryption
 no logging cons
 no ip domain lookup
 line vty 0 14
  transport input all
  password pass
  login local
  exec-timeout 0 0
 int g1
  ip add 208.8.8.11 255.255.255.0
  no shut
 int g2
  ip add 192.168.102.11 255.255.255.0
  no shut
 int g3
  ip add 11.11.11.113 255.255.255.224
  no shut
  exit
 !
 ip route 0.0.0.0 0.0.0.0 208.8.8.2
 ip domain lookup
 ip name-server 8.8.8.8 1.1.1.1
 !
 username admin privilege 15 secret pass
 ip http server
 ip http secure-server
 ip http authentication local
 end
wr
!
~~~

<br>

~~~
!@BLDG-PH
sudo su
ifconfig eth0 11.11.11.111 netmask 255.255.255.224 up
route add default gw 11.11.11.113
ping 11.11.11.113
~~~


<br>


### NetOps-PH Setup
> Login: root
> Pass: C1sc0123



### 1. Get the MAC Address for the Bridge connection
VMWare > NetOps-PH Settings > NetAdapter (2, 3, & 4) > Advance > MAC Address

| NetAdapter   | MAC Address      | VM Interface |           |
| ---          | ---              | ---          | ---       |
| NetAdapter 2 | ___.___.___.___  | ens___       |  ens192   |
| NetAdapter 3 | ___.___.___.___  | ens___       |  ens224   |
| NetAdapter 4 | ___.___.___.___  | ens___       |  ens256   |


<br>

### 2. Get Network-VM Mapping

~~~
!@NetOps-PH
ip -br link
~~~


<br>

### 3. Modify Interface IP
VMNet2:  192.168.102.6/24
VMNet3:  11.11.11.100/27
Bridged: 10.11.1.6/24

<br>

~~~
!@NetOps-PH
ifconfig ens192 192.168.102.6 netmask 255.255.255.0 up
ifconfig ens224 11.11.11.100 netmask 255.255.255.224 up
ifconfig ens256 10.11.1.6 netmask 255.255.255.0 up
~~~

or 

<br>

__Using Network Management CLI for persistent IP.__

~~~
!@NetOps-PH
nmcli connection add \
type ethernet \
con-name VMNET2 \
ifname ens192 \
ipv4.method manual \
ipv4.addresses 192.168.102.6/24 \
autoconnect yes

nmcli connection up VMNET2


nmcli connection add \
type ethernet \
con-name VMNET3 \
ifname ens224 \
ipv4.method manual \
ipv4.addresses 11.11.11.100/27 \
autoconnect yes

nmcli connection up VMNET3


nmcli connection add \
type ethernet \
con-name BRIDGED \
ifname ens256 \
ipv4.method manual \
ipv4.addresses 10.11.1.6/24 \
autoconnect yes

nmcli connection up BRIDGED


ip route add 10.0.0.0/8 via 10.11.1.4 dev ens256
ip route add 200.0.0.0/24 via 10.11.1.4 dev ens256
ip route add 0.0.0.0/0 via 11.11.11.113 dev ens224
~~~


<br>


__Make Sure EDGE-11 is Configured__

~~~
!@EDGE-11
conf t
 hostname EDGE-11
 enable secret pass
 service password-encryption
 no logging console
 no ip domain-lookup
 line cons 0
  password pass
  login
  exec-timeout 0 0
 line vty 0 14
  password pass
  login
  exec-timeout 0 0
 int gi 0/0/0
  no shut
  ip add 10.11.11.1 255.255.255.0
  desc INSIDE
 int gi 0/0/1
  no shut
  ip add 200.0.0.11 255.255.255.0
  desc OUTSIDE
 int loopback 0
  ip add 11.0.0.1 255.255.255.255
  desc VIRTUALIP
  exit
  
!@ospf routing edge
 router ospf 1
  router-id 11.0.0.1
  network 200.0.0.0 0.0.0.255 area 0
  network 10.11.11.0 0.0.0.255 area 0
  network 11.0.0.1 0.0.0.0 area 0
 int gi 0/0/0
  ip ospf network point-to-point
 end
~~~

<br>

~~~
!@BABA-11
conf t
 hostname coreBaba-11
 enable secret pass
 service password-encryption
 no logging console
 no ip domain-lookup
 line cons 0
  password pass
  login
  exec-timeout 0 0
 line vty 0 14
  password pass
  login
  exec-timeout 0 0
 int gi 0/1
  no shut
  no switchport
  ip add 10.11.11.4 255.255.255.0
 int vlan 1
  no shut
  ip add 10.11.1.4 255.255.255.0
  desc DEFAULT-VLAN
 int vlan 10
  no shut
  ip add 10.11.10.4 255.255.255.0
  desc WIFI-VLAN
 int vlan 50
  no shut
  ip add 10.11.50.4 255.255.255.0
  desc CCTV-VLAN
 int vlan 100
  no shut
  ip add 10.11.100.4 255.255.255.0
  desc VOICE-VLAN
  exit
 !
 vlan 10
  name WIFIVLAN
 vlan 50
  name CCTVVLAN
 vlan 100
  name VOICEVLAN
 int fa 0/2
  switchport mode access
  switchport access vlan 10
 int fa 0/4
  switchport mode access
  switchport access vlan 10
 int fa 0/6
  switchport mode access
  switchport access vlan 50
 int fa 0/8
  switchport mode access
  switchport access vlan 50
 int fa 0/3
  switchport mode access
  switchport access vlan 100
 int fa 0/5
  switchport mode access
  switchport voice vlan 100
  switchport access vlan 1
  mls qos trust device cisco-phone
 int fa 0/7
  switchport mode access
  switchport voice vlan 100
  switchport access vlan 1
  mls qos trust device cisco-phone
  exit
 !
 router ospf 1
  router-id 10.11.11.4
  network 10.11.0.0 0.0.255.255 area 0
 int gi 0/1
  ip ospf network point-to-point
  end
~~~

<br>

~~~
!@CUCM-11
conf t
 hostname CUCM-11
 enable secret pass
 service password-encryption
 no logging console
 no ip domain-lookup
 line cons 0
  password pass
  login
  exec-timeout 0 0
 line vty 0 14
  password pass
  login
  exec-timeout 0 0
 int fa 0/0
  no shut
  ip add 10.11.100.8 255.255.255.0
  exit
 router ospf 1
  router-id 10.11.100.8
  network 10.11.100.0 0.0.0.255 area 0
  end
~~~


<br>
<br>

---
&nbsp;


## Traffic Filtering
~~~
!@NetOps-PH
youporn.com       66.254.114.79
pornhub.com       66.254.114.41
redtube.com       66.254.114.238
faketaxi.com      66.254.114.234
bangbros.com      66.254.114.234
bangbus.com       104.21.5.229
                  172.67.133.243
pinayflix.com     172.67.146.93
xhamster.com      104.18.146.40  
iyottube.com      208.77.20.35
~~~

<br>

### Task 1: Protect your most important asset: The brain
~~~
!@UTM-PH
config t
 no ip access-list standard FWP1
 ip access-list standard FWP1
  deny __.__.__.__  __.__.__.__ log
  deny __.__.__.__  __.__.__.__ log
  deny __.__.__.__  __.__.__.__ log
  permit any
 int gi 1
  ip access-group FWP1 in
  end
show ip access-list int g1
~~~

<br>

Remove the access-list
~~~
!@UTM-PH
conf t
 int gi 1
  no ip access-group FWP1 in
  end
~~~


<br>


### Task 2: Block Classmates
__X1  vs  X2__

~~~
!@EDGE-11
config t
 no ip access-list extended NOCLASSMATES
 ip access-list extended NOCLASSMATES
  deny ip __.__.__.__  __.__.__.__  __.__.__.__  __.__.__.__ log
  deny ip 10.11.0.0 0.0.255.255 any log
  permit ip any any
 int gi 0/0/1
  ip access-group NOCLASSMATES in
  end
show ip access-list int g1
~~~


<br>


### Task 3: Modify the ACL so that only the PCs of Blocked Classmates 
will be able to gain access to the blocked network.

~~~
!@EDGE-11
config t
 ip access-list extended NOCLASSMATES
  1 permit ip host __.__.__.__ any log
  2 permit ip __.__.__.__  __.__.__.__ any log
  end
show ip access-list int g1
~~~

<br>


Remove the ACL
~~~
!@EDGE-11
conf t
 int gi 0/0/1
  no ip access-group NOCLASSMATES in
  end
~~~


<br>


### Exam Question:

~~~
The security team has been asked to only enable host A (10.2.2.7) and host B (10.3.9.9)
to the new isolated network segment (10.9.8.14) that provides access to legacy devices.
Access from all other hosts should be blocked. Which of the following entries would
need to be added on the firewall?

A.
  Permit 10.2.2.0/24 to 10.9.8.14/27
  Permit 10.3.9.0/24 to 10.9.8.14/27
  Deny 0.0.0.0/0 to 10.9.8.14/27

B.
  Deny 0.0.0.0/0 to 10.9.8.14/27
  Permit 10.2.2.0/24 to 10.9.8.14/27
  Permit 10.3.9.0/24 to 10.9.8.14/27

C.
  Permit 10.2.2.7/32 to 10.9.8.14/27
  Permit 10.3.9.9/32 to 10.9.8.14/27
  Deny 0.0.0.0/0 to 10.9.8.14/27
  
D.
  Permit 10.2.2.7/32 to 10.9.8.14/27
  Permit 10.3.9.0/24 to 10.9.8.14/27
  Deny 10.9.8.14/27 to 0.0.0.0/0
~~~

<br>
<br>

---
&nbsp;



## L4 Firewall Rules

`www.rivanit.com` vs `neu.edu.ph` vs 'sti.edu.ph' vs `fbi.gov`


<br>

Make the UTM Router Vulnerable
~~~
!@UTM-PH
config t
 int g1
  ip add 208.8.8.100 255.255.255.0 secondary
  no shut
  exit
 ip host www.bet100.com 208.8.8.100
 service finger
 service tcp-small-servers
 service udp-small-servers
 ip dns server
 ip http server
 ip http secure-server
 telephony-service
  no auto-reg-ephone
  max-ephones 5
  max-dn 20
  ip source-address 208.8.8.11 port 2000
  exit
 voice service voip
  allow-connections h323 to sip
          
  allow-connections sip to h323
  allow-connections sip to sip
  supplementary-service h450.12
 sip
   bind control source-interface g1
   bind media source-interface g1
   registrar server expires max 600 min 60
 voice register global
  mode cme
  source-address 208.8.8.11 port 5060
  max-dn 12
  max-pool 12
  authenticate register
  create profile sync syncinfo.xml
  end
~~~


<br>


### Task 4: Create an extended ACL named FWP2
Open only the following ports:
  ssh, http, https  


Formula:  

|  PROTOCOL       |  HACKER  |  VICTIM  |  PORT         |
| ---             | ---      | ---      | ---           |
| TCP/UDP/ICMP/IP |   ANY    |          |  Dest.Port eq |


__SYSLOG__
~~~
!@UTM-PH
conf t
 service timestamps log datetime
 service timestamps debug datetime
 logging 10.11.1.10
 logging trap 5
 end
wr
~~~

<br>

~~~
!@UTM-PH
conf t
 no ip access-list extended FWP2
 ip access-list extended FWP2
 permit __ Any host www.____.com eq __ log
 permit __ Any host www.____.com eq __ log
 permit __ Any host www.____.com eq __ log
 int gi 1
  ip access-group FWP2 in
  end
~~~

<br>

Remove the ACL
~~~
@UTM-PH
config t
 int gi 1
  no ip access-group FWP2 in
end
~~~


<br>


### Task 5: Become Praning like STI  
Create an extended ACL named FWP3  
- Block Everything including PING  

~~~
!@UTM-PH
conf t
 no ip access-list extended FWP3
 ip access-list extended FWP3
  deny ip any any
 int gi 1
  ip access-group FWP3 in
  end
~~~

<br>

Remove the ACL
~~~
@UTM-PH
config t
 int gi 1
  no ip access-group FWP3 in
end
~~~



<br>

Review on Ports:

| Port   | No.  | Port   | No.   |
| ---    | ---  | ---    | ---   |
| Telnet |      | SMTPS  |       |
| SSH    |      | IMAPS  |       |
| DNS    |      | POP3S  |       |
| HTTP   |      | MYSQL  |       |
| HTTPS  |      | SCCP   |       |
| SMTP   |      | SIP    |       |
| IMAP   |      | FTP    |       |
| POP3   |      | TFTP   |       |

<br>


### Task 6: On the EDGE-11 router:  
Create an extended ACL named LIMIT-TELNET
- Block all Telnet access on CoreBABA on:
  - VLAN 10  - 10.11.10.4
  - VLAN 50  - 10.11.50.4
  - VLAN 100 - 10.11.100.4 
  
Make sure only 10.11.1.4 can be connected via Telnet on CoreBABA

~~~
!@EDGE-11
conf t
 no ip access-list extended LIMIT-TELNET
 ip access-list extended LIMIT-TELNET
  deny __ Any host __.__.__.__ eq __ log
  deny __ Any host __.__.__.__ eq __ log
  deny __ Any host __.__.__.__ eq __ log

 Int gi 0/0/1
  ip access-group LIMIT-TELNET in
  end
~~~


<br>


### Exam Question:

~~~
An enterprise is trying to limit outbound DNS traffic originating from its internal network. Outbound DNS requests
will only be allowed from one device with the IP address 10.50.10.25. Which of the following firewall ACLs will
accomplish this goal?

A.
  Access list outbound permit 0.0.0.0/0 0.0.0.0/0 port 53
  Access list outbound deny 10.50.10.25/32 0.0.0.0/0 port 53

B.
  Access list outbound permit 0.0.0.0/0 10.50.10.25/32 port 53
  Access list outbound deny 0.0.0.0/0 0.0.0.0/0 port 53

C.
  Access list outbound permit 0.0.0.0/0 0.0.0.0/0 port 53
  Access list outbound deny 0.0.0.0/0 10.50.10.25/32 port 53

D.
  Access list outbound permit 10.50.10.25/32 0.0.0.0/0 port 53
  Access list outbound deny 0.0.0.0/0 0.0.0.0/0 port 53
~~~


<br>
<br>

---
&nbsp;



## Network Segmentation/Isolation

### 1. Deploy
Devices:  
- 1x TinyCore (yvm.ova)  


TinyCore (yvm.ova):
  Name: BLDG-JP-1
  
  | NetAdapter   |                    |
  | ---          | ---                |
  | NetAdapter   | NAT                |


<br>

~~~
!@BLDG-JP-1
sudo su
ifconfig eth0 208.8.8.211 netmask 255.255.255.0 up
route add default gw 208.8.8.11
ping 208.8.8.11
~~~


<br>


Create a user account on BLDG-JP-1
~~~
!@BLDG-JP-1
sudo su
deluser admin
adduser admin

> pass
> pass
~~~ 


<br>


### Zone Based Firewall
Establish Zero Trust  

G1: OUTSIDE  
G2: INSIDE  
G3: DMZ  


<br>


### Task 7: Modify SSH Port on Linux
Prevent easy brute force attacks

~~~
!@NetOps
nano /etc/ssh/sshd_config
~~~

<br>

Modify SSH Port:
> Set Port to 2202

<br>

~~~
!@NetOps
sudo semanage port -a -t ssh_port_t -p tcp 2202
systemctl restart sshd
~~~


<br>


__SELinux__
SELinux defines access controls for the applications, processes, and files on a system. 
It uses security policies, which are a set of rules that tell SELinux what can or can’t be accessed, 
to enforce the access allowed by a policy. 


<br>
<br>

---
&nbsp;


## Port Forwarding

`www.fbi.gov` vs `www.cia.gov`


Configure NAT
~~~
!@UTM-PH
conf t
 int g1
  ip nat outside
 int range g2,g3
  ip nat inside
  exit
 access-list 1 permit any
 ip nat inside source list 1 int g1 overload
 end
~~~


<br>

### Task 8: Set Portforwarding Rules for
- 208.8.8.11 8080 > 11.11.11.111 80
- 208.8.8.11 8443  > 11.11.11.111 443
- 208.8.8.11 2222 > 11.11.11.100 22

~~~
!@UTM
conf t
 ip nat inside source static tcp 11.11.11.111 80 208.8.8.11 8080
 ip nat inside source static tcp 11.11.11.111 443 208.8.8.11 8443
 ip nat inside source static tcp 11.11.11.100 22 208.8.8.11 2222
 end
~~~


<br>
<br>

---
&nbsp;


## Honeypot/Honeynet
~~~
!@cmd
nmap -v www.dpwh.gov.ph
~~~


<br>


### 1. Create a python file for the honeypot operation.
~~~
!@NetOps
sudo nano /usr/local/bin/tcp-6969-honeypot.py
~~~


<br>

Then paste the following contents to the nano shell.

<br>


~~~
#!/usr/bin/env python3
import asyncio
import datetime
import os
import argparse
import binascii
import pathlib

### LOG FILE LOCATION
BASE_LOG = '/var/log/tcp-6969-honeypot'
os.makedirs(BASE_LOG, exist_ok=True)


### CONVERT RAW BYTES TO HUMAN READABLE DATA
def hexdump(data: bytes) -> str:

  ### CONVERT RAW BYTES TO HEX STRINGS
  hexs = binascii.hexlify(data).decode('ascii')
  
  ### LOOP 32 CHAR CHUNKS TO BE A HUMAN READABLE DATA
  lines = []
  for i in range(0, len(hexs), 32):
    chunk = hexs[i:i+32]
    b = bytes.fromhex(chunk)
    printable = ''.join((chr(x) if 32 <= x < 127 else '.') for x in b)
    lines.append(f'{i//2:08x} {chunk} {printable}')
  return '\n'.join(lines)


### LOG INFORMATION ABOUT THE ATTACKER
async def handle(reader: asyncio.StreamReader, writer: asyncio.StreamWriter):
  
  ### IDENTIFY ATTACKER IP
  peer = writer.get_extra_info('peername')
  if peer is None:
    peer = ('unknown', 0)
  ip, port = peer[0], peer[1]
  
  
  ### SESSION LOGS - Year-Month-Day Hour-Minutes-Seconds
  start = datetime.datetime.utcnow().strftime("%Y%m%dT%H%M%SZ")
  sess_name = f"{start}_{ip.replace(':','_')}_{port}"
  sess_dir = pathlib.Path(BASE_LOG) / sess_name
  sess_dir.mkdir(parents=True, exist_ok=True)
  meta_file = sess_dir / "meta.txt"
  
  ### WRITE SESSION LOGS
  with meta_file.open("w") as mf:
    mf.write(f"start: {start}\npeer: {ip}:{port}\n")
  print(f"[+] connection from {ip}:{port} -> {sess_dir}")


  ### SEND MESSAGE TO THE ATTACKER
  try:
    writer.write(b'Welcome to Rivan, you Hacker!!! \r\n')
    await writer.drain()
  except Exception:
    pass


  ### DUMP RAW AND HEX DATA
  raw_file = sess_dir / "raw.bin"
  hexd_file = sess_dir / "hexdump.txt"
  try:
    with raw_file.open("ab") as rb, hexd_file.open("a") as hf:
      while True:
        data = await asyncio.wait_for(reader.read(4096), timeout=300.0)
        if not data:
          break
        ts = datetime.datetime.utcnow().isoformat() + "Z"
        rb.write(data)
        hf.write(f"\n-- {ts} --\n")
        hf.write(hexdump(data) + "\n")
        
        ### RECORD READABLE COPY
        printable = ''.join((chr(x) if 32 <= x < 127 else '.') for x in data)
        with (sess_dir / "printable.log").open("a") as pf:
          pf.write(f"{ts} {printable}\n")
        
        ### SEND TARPITTED RESPONSE
        try:
          writer.write(b"OK\r\n")
          await writer.drain()
        except Exception:
          break
  except asyncio.TimeoutError:
    print(f"[-] connection timed out {ip}:{port}")
  except Exception as e:
    print(f"[-] session error {e}")
  finally:
    try:
      writer.close()
      await writer.wait_closed()
    except Exception:
      pass
    end = datetime.datetime.utcnow().strftime("%Y%m%dT%H%M%SZ")
    with meta_file.open("a") as mf:
      mf.write(f"end: {end}\n")
    print(f"[+] closed {ip}:{port} -> {sess_dir}")


### TCP HANDLER
async def main(host, port):
  server = await asyncio.start_server(handle, host, port)
  addrs = ", ".join(str(sock.getsockname()) for sock in server.sockets)
  print(f"Listening on {addrs}")
  async with server:
    await server.serve_forever()
      
### CLI ENTRYPOINT
if __name__ == "__main__":
  parser = argparse.ArgumentParser()
  parser.add_argument("--host", default="0.0.0.0")
  parser.add_argument("--port", type=int, default=6969)
  args = parser.parse_args()
  try:
    asyncio.run(main(args.host, args.port))
  except KeyboardInterrupt:
    pass
~~~


<br>


> [!NOTE]
> Imports
> - asyncio: event loop + async IO (handles many connections efficiently).
> - datetime: timestamps.
> - os, pathlib: filesystem operations.
> - argparse: parse CLI arguments (--host, --port).
> - binascii: binary ⇄ hex conversion.


<br>


### 2. Create the directory for the log files.
~~~
!@NetOps
sudo mkdir /var/log/tcp-6969-honeypot
~~~

<br>

Make the file excecutable

<br>

~~~
!@NetOps
sudo chmod +x /usr/local/bin/tcp-6969-honeypot.py
~~~


<br>


### 3. Prevent the honeypot server from being compronised by assigning a nologin account to it.
~~~
!@NetOps
sudo useradd -r -s /sbin/nologin honeypot69 || true
sudo chown -R honeypot69:honeypot69 /var/log/tcp-6969-honeypot
~~~


<br>


### 4. Create a Systemd Service unit file
~~~
!@NetOps
nano /etc/systemd/system/tcp-6969-honeypot.service
~~~


<br>

Then paste the following

<br>


~~~
[Unit]
Description=A TCP Honeypot for port 6969
After=network.target

[Service]
User=honeypot69
Group=honeypot69
ExecStart=/usr/local/bin/tcp-6969-honeypot.py --host 0.0.0.0 --port 6969
Restart=on-failure
RestartSec=5
TimeoutStopSec=10
ProtectSystem=full
ProtectHome=yes
NoNewPrivileges=yes
PrivateTmp=yes
PrivateNetwork=no
ReadOnlyPaths=/usr
AmbientCapabilities=
SystemCallFilter=~@clock @cpu-emulation

[Install]
WantedBy=multi-user.target
~~~


<br>


### 5. Then start the service
~~~
!@NetOps
sudo systemctl daemon-reload
sudo systemctl start tcp-6969-honeypot.service
sudo systemctl status tcp-6969-honeypot.service --no-pager
~~~


<br>


### 6. OPTIONAL
If binding to ports below 1024 use the following systemd setup

~~~
NoNewPrivileges=No
AmbientCapabilities=CAP_NET_BIND_SERVICE
~~~


<br>


### Task 8: Set a port forwarding rule for the honeypot and modify the firewall to allow any access to the honeypot port.













<br>
<br>

---
&nbsp;


## Site-to-Site VPN & Cryptography

### Lab Setup
Devices:
- 2x CSR1000v
- 1x NetOps
- 2x TinyCore (yvm.ova)


CSR1000v:
  Name: UTM-PH
  
  | NetAdapter   |        |
  | ---          | ---    |
  | NetAdapter   | NAT    |
  | NetAdapter 2 | VMNet2 |
  | NetAdapter 3 | VMNet3 |
  

CSR1000v:
  Name: UTM-JP
  
  | NetAdapter   |        |
  | ---          | ---    |
  | NetAdapter   | NAT    |
  | NetAdapter 2 | VMNet2 |
  | NetAdapter 3 | VMNet4 |


NetOps:
  Name: NetOps-PH
  
  | NetAdapter   |                    |
  | ---          | ---                |
  | NetAdapter   | VMNet1             |
  | NetAdapter 2 | VMNet2             |
  | NetAdapter 3 | VMNet3             |
  | NetAdapter 4 | Bridge (Replicate) |


TinyCore (yvm.ova):
  Name: BLDG-JP-1
  
  | NetAdapter   |                    |
  | ---          | ---                |
  | NetAdapter   | VMNet4             |


TinyCore (yvm.ova):
  Name: BLDG-JP-2
  
  | NetAdapter   |                    |
  | ---          | ---                |
  | NetAdapter   | VMNet4             |


<br>


### 2. Bootstrap
~~~
!@UTM-PH
conf t
 hostname UTM-PH
 enable secret pass
 service password-encryption
 no logging cons
 no ip domain lookup
 line vty 0 14
  transport input all
  password pass
  login local
  exec-timeout 0 0
 int g1
  ip add 208.8.8.11 255.255.255.0
  no ip add 208.8.8.100 255.255.255.0 secondary
  no ip nat outside
  no shut
 int g2
  ip add 192.168.102.11 255.255.255.0
  no ip nat inside
  no shut
 int g3
  ip add 11.11.11.113 255.255.255.224
  no ip nat inside
  no shut
 !
 username admin privilege 15 secret pass
 ip http server
 ip http secure-server
 ip http authentication local
 !
 no ip nat inside source list 1 int g1 overload
 end
wr
!
~~~

<br>

~~~
!@UTM-JP
conf t
 hostname UTM-JP
 enable secret pass
 service password-encryption
 no logging cons
 no ip domain lookup
 line vty 0 14
  transport input all
  password pass
  login local 
  exec-timeout 0 0
 int g1
  ip add 208.8.8.12 255.255.255.0
  no shut
 int g2
  ip add 192.168.102.12 255.255.255.0
  no shut
 int g3
  ip add 21.21.21.213 255.255.255.240
  ip add 22.22.22.223 255.255.255.192 secondary
  no shut
 !
 username admin privilege 15 secret pass
 ip http server
 ip http secure-server
 ip http authentication local
 end
wr
!
~~~

<br>

~~~
!@BLDG-JP-1
sudo su
ifconfig eth0 21.21.21.211 netmask 255.255.255.240 up
route add default gw 21.21.21.213
ping 21.21.21.213
~~~

<br>

~~~
!@BLDG-JP-2
sudo su
ifconfig eth0 22.22.22.221 netmask 255.255.255.192 up
route add default gw 22.22.22.223
ping 22.22.22.223
~~~


<br>


### 1. Create a Key Pair for both UTM Routers

~~~
!@UTM-PH & UTM-JP
conf t
 ip domain name sec.plus
 !
 crypto key generate rsa modulus 2048 label key exportable
 ip ssh version 2
 ip ssh rsa keypair-name key
 end
show ip ssh
~~~


<br>


View Private & Public Keys
~~~
!@UTM-PH & UTM-JP
conf t
 crypto key export rsa key pem terminal aes C1sc0123
 end
~~~


<br>


### Diffie-Hellman Key Exchange 
Ref: https://sec.cloudapps.cisco.com/security/center/resources/next_generation_cryptography

<br>

| DH GROUP | MODP                      | EC  |
| ---      | ---                       | --- |
| 1 	   | 768                       |     |
| 2 	   | 1024                      |     |
| 5 	   | 1536                      |     |
| 14 	   | 2048                      |     | 
| 15 	   | 3072                      |     |
| 16 	   | 4096                      |     |
| 17 	   | 6144                      |     |
| 18 	   | 8192                      |     |
| 19       |                           | 256 |
| 20       |                           | 384 |
| 21       |                           | 521 |
| 24       | 2048 Prime order 256 bits |     |


<br>

~~~
!@NetOps-PH
mkdir crypto; cd crypto
openssl dhparam -out dhgroup.pem 1024
~~~

<br>

~~~
openssl genpkey -paramfile dhgroup.pem -out ph_priv.key
openssl genpkey -paramfile dhgroup.pem -out jp_priv.key
~~~

<br>

~~~
openssl pkey -in ph_priv.key -pubout -out ph_pub.key
openssl pkey -in jp_priv.key -pubout -out jp_pub.key
~~~

<br>

~~~
openssl pkeyutl -derive -inkey ph_priv.key -peerkey jp_pub.key -out ph-shared.secret
openssl pkeyutl -derive -inkey jp_priv.key -peerkey ph_pub.key -out jp-shared.secret
~~~

<br>

View Private key contents
~~~
!@NetOps
openssl pkey -in rsa_priv.key -text -noout
~~~

<br>

### 2. Access the GUI of Both UTM Routers

UTM-PH: https://192.168.102.11
UTM-JP: https://192.168.102.12

<br>

Wireshark: ssh vs telnet vs esp








<br>


### Exam Question:

~~~
Which of the following would most likely be deployed to obtain and analyze attacker
activity and techniques?
A. Firewall
B. IDS
C. Honeypot
D. Layer 3 switch


Employees located off-site must have access to company resources in order to complete
their assigned tasks. These employees utilize a solution that allows remote access
without interception concerns. Which of the following best describes this solution?
A. Proxy server
B. NGFW
C. VPN
D. Security zone
~~~


<br>
<br>

---
&nbsp;



## Proxy Chaining


### Setup
~~~
!@UTM-PH
conf t
 no ip route 0.0.0.0 0.0.0.0 208.8.8.2
 ip route 0.0.0.0 0.0.0.0 172.16.1.2
 end
~~~


<br>


~~~
!@UTM-JP
conf t
 ip route 0.0.0.0 0.0.0.0 208.8.8.2
 int g1
  ip nat outside
 int range g2,g3,tun1
  ip nat inside
 access-list 1 permit any
 ip nat inside source list 1 int g1 overload
 end
~~~


__Modify SOCKS5 File
~~~
!@NetOps
nano /etc/sockd.conf
~~~


<br>


~~~
logoutput: syslog
internal: ens192 port = 1080
external: eth224

method: none

client pass {
  from: 0.0.0.0/0 to: 0.0.0.0/0
}

pass {
  from: 0.0.0.0/0 to: 0.0.0.0/0
  protocol: tcp udp
}
~~~


<br>

~~~
!@NetOps-PH
systemctl start sockd
~~~


<br>

Access Firefox Proxy Settings
- Manual Proxy
- SOCKS5 host IP of NetOps port 1080
- Proxy DNS


<br>
<br>

---
&nbsp;


## Secure Authentication Methods & Privilege Access Management Solutions
Generate SSH Keys:

__CISCO__
~~~
!@UTM-PH
conf t
 ip domain name sec.plus
 !
 crypto key generate rsa modulus 2048 label key exportable
 ip ssh version 2
 ip ssh rsa keypair-name key
 end
show ip ssh
~~~


<br>


__LINUX:__
~~~
!@NetOps-PH
ssh-keygen -t rsa -b 1024 -f rsa.key
fold -w 46 rsa.key.pub
~~~


<br>


__RSA__ vs __ECDSA__ vs __ED25519__


__RSA (Rivest Shamir Adleman)__
- Algo: Integer factorization
- Key Size: 2048-4096 bits
  

__ECDSA (Elliptical Curve Digital Signature)__
- Algo: Elliptic-curve (NIST P-256/384/521)
- Key Size: 256, 384, 521 bits


__ED25519 (Edwards Curve over the 2^255-19 prime field)__
- Algo: Elliptic-curve (Curve25519)
- Key-Size: 256 bits


<br>
<br>

---
&nbsp;


### ECDSA Key Pair

__LINUX:__
~~~
!@NetOps-PH
ssh-keygen -t ecdsa -b 521 -f ec.key
fold -w 46 ec.key.pub
~~~


<br>


__CISCO:__
~~~
!@UTM-PH
conf t
 crypto key generate ec keysize 256 label key exportable
 end
~~~


<br>
<br>

---
&nbsp;


### ED25519 Key Pair

__LINUX:__
~~~
!@NetOps-PH
ssh-keygen -t ed25519 -a 256 -f ed.key
fold -w 46 ed.key.pub
~~~


<br>


__CISCO:__
~~~
!@UTM-PH
conf t
 crypto key generate ed25519 keysize 256 label key exportable
 end
~~~


<br>


### Task 9: Create accounts on both Cisco and Linux servers then attach the public key to accounts.
~~~
!@UTM-PH
conf t
 username admin priv 15 secret pass
 username rivanph priv 15 secret pass
 username ______  priv 15 secret pass
 end
~~~


<br>


~~~
!@NetOps-PH
adduser rivanph
passwd rivanph
~~~


<br>


__CISCO:__
~~~
!@UTM-PH
conf t
 ip ssh pubkey-chain
  username rivanph
   key-string
    <PASTE PUB KEY>
	exit
   end
~~~


<br>


Disable Password authentication.
~~~
!@UTM-PH
conf t
 ip ssh server algorithm authentication publickey
 no ip ssh server algorithm authentication password
 no ip ssh server algorithm authentication keyboard
 end
~~~


<br>


__LINUX:__
~~~
!@NetOps-PH
nano /etc/ssh/ssh_config.d
cat key.pub >> /.ssh/authorized_keys

Paste Public Keys
~~~


<br>


### Exam Question:

~~~
A company wants to ensure that a mission-critical database can only be accessed from
specific internal IP addresses. Which of the following should the company deploy to
meet this requirement?
A. Web application firewall
B. Network tap
C. Intrusion prevention system
D. Jump server


An administrator is creating a secure method for a contractor to access a test
environment. Which of the following would provide the contractor with the best access to
the test environment?
A. Application server
B. Jump server
C. RDP server
D. Proxy server
~~~


<br>
<br>

---
&nbsp;






















Check Supported Ciphers/Cipher Suite

Directory:
C:\ProgramData\Microsoft\Crypto\Keys


!@NetOps
openssl ciphers -v

DNS:
ns   A
ca   A
cert CNAME
__   A
www  A
ftp  CNAME

*******************

SETUP
!@NetOps
mkdir /certs;cd /certs



In order to create an SSL Cert, Certificates MUST be configured.

STEP 1. Create a self-signed cert on linux using openssl. (Sakit ulo windows certreq)

> GENERATE PRIVATE KEY

SERVER
For root CA (NetOps) 
!@NetOps
openssl genrsa -aes256 -out netops-ca.key 2048

SUBCA
For root SUBCA (NetOps) 
!@NetOps
openssl genrsa -aes256 -out netops-subca.key 2048

or

CLIENT
For (Windows)
!@Powershell
$ca = New-SelfSignedCertificate `
  -Subject "CN=RivanCyber Institute CEBU, O=Rivancorp, OU=ICT, L=Cebu, ST=Central Visayas, C=PH" `
  -DnsName "ns.rivancorp.com" `
  -KeyAlgorithm RSA `
  -KeyLength 2048 `
  -HashAlgorithm SHA256 `
  -KeyUsage CertSign, CRLSign, DigitalSignature `
  -KeyUsageProperty Sign `
  -CertStoreLocation "Cert:\LocalMachine\My" `
  -TextExtension @(
    "2.5.29.19={text}ca=true&pathlength=1"
  ) `
  -NotAfter (Get-Date).AddYears(10)


Then, Create and Export the CA

!@NetOps
cd /certs
ftp [IP Address]
ftp> binary
ftp> get win.pfx


> Create an OPENSSL configuration file to support Subject Alt Names

SERVER
!@NetOps
nano ca.cnf

~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_ca
prompt             = no
default_md         = sha256

[ req_distinguished_name ]
C  = PH
ST = NCR
L  = Manila
O  = Rivancorp
OU = Admin
CN = Rivancorp Root CA

[ v3_ca ]
basicConstraints = critical, CA:true
keyUsage = critical, keyCertSign, cRLSign
subjectKeyIdentifier = hash

[v3_subca]
basicConstraints = critical, CA:true
keyUsage = critical, keyCertSign, cRLSign
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
~~~



SERVER
!@NetOps
nano subca.cnf

~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_subca
prompt             = no
default_md         = sha256

[ req_distinguished_name ]
C  = PH
ST = NCR
L  = Manila
O  = Rivancorp
OU = IT Department
CN = Rivancorp SubCA

[ v3_subca ]
basicConstraints = critical, CA:true, pathlen:0
keyUsage = critical, keyCertSign, cRLSign
~~~




CLIENT
!@NetOps
nano win.cnf

~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_leaf
prompt             = no

[ req_distinguished_name ]
C  = PH
ST = Central Visayas
L  = Cebu
O  = Rivancorp
OU = ICT
CN = www.rivancorp.com

[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1   = www.rivancorp.com
DNS.2   = rivancorp.com
IP.1    = 192.168.102.100
~~~



> OUTPUT SELF-SIGNED CA

SERVER
!@NetOps
openssl req \
-new -x509 \
-key netops-ca.key \
-out netops-ca.crt \
-days 365 \
-extensions v3_ca \
-config ca.cnf


> CREATE A CSR FOR THE SUBCA USING THE SELFSIGNED CA

SERVER SUBCA
!@NetOps
openssl req -new \
-key netops-subca.key \
-out netops-subca.csr \
-config subca.cnf \
-extensions v3_subca


> SIGN THE SUBCA CSR USING THE SELFSIGNED CA

!@NetOps
openssl x509 -req \
-in netops-subca.csr \
-CA netops-ca.crt \
-CAkey netops-ca.key \
-CAcreateserial \
-out netops-subca.crt \
-days 3650 \
-extfile ca.cnf \
-extensions v3_subca \
-copy_extensions copy



STEP 2. Generate then sign the CSR for the client

*IF PFX WAS GENERATED BY WINDOWS

> OUTPUT THE PRIVATE KEY
!@NetOps
openssl pkcs12 -in win.pfx -nocerts -out win.key -nodes


> EXPORT THE CERTIFICATE
!@NetOps
openssl pkcs12 -in win.pfx -nokeys -out win.crt

********


> GENERATE A CERTIFICATE SIGNING REQUEST

!@NetOps
openssl req -new \
-key win.key \
-out win.csr \
-config win.cnf \
-extensions v3_leaf


> SIGN THE CSR

Create another file:
!@NetOps
nano win-ext.cnf

~~~
[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = www.rivancorp.com
DNS.2 = rivancorp.com
IP.1  = 192.168.102.200
~~~


!@NetOps
openssl x509 -req \
  -in win.csr \
  -CA netops-subca.crt \
  -CAkey netops-subca.key \
  -CAcreateserial \
  -out grant-win.pem \
  -days 365 \
  -extfile win-ext.cnf \
  -extensions v3_leaf





STEP 3. Convert the granted certificate to PFX format

> CONVERT PEM TO PFX

!@NetOps
openssl pkcs12 -export \
-in grant-win.pem \
-inkey win.key \
-out grant-win.pfx




STEP 4. Transfer the CA & Granted Certificate to Windows.

> ENABLE FTP ON WINDOWS SERVER



> TRANSFER FILES VIA FTP - NOTE: Make sure PFX files are transferred in Binary NOT ASCII

!@NetOps
cd /certs
ftp [IP]

ftp> put netops-ca.crt
ftp> binary
ftp> put grant-win.pfx



STEP 5. Install the Granted Certificates on Windows IIS

Win + R : mmc


> ADD THE CA (netops.crt) to the Trusted Root Certification Authorities

> INSTALL THE GRANTED CERT (grant-win.pfx) in IIS Manager








*******************
TRANSPORT LAYER SECURITY

> Setup FTP with SSL Certificate

> CREATE ANOTHER SIGNED CERT FOR LINUX

CLIENT
!@NetOps
nano linux.cnf

~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_leaf
prompt             = no

[ req_distinguished_name ]
C  = PH
ST = Central Visayas
L  = Cebu
O  = Rivancorp
OU = FTP
CN = ftp.rivancorp.com

[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1   = ftp.rivancorp.com
DNS.2   = rivancorp.com
IP.1    = 192.168.102.10
~~~


> GENERATE A CERTIFICATE SIGNING REQUEST

!@NetOps
openssl req -new \
-key netops-ca.key \
-out linux.csr \
-config linux.cnf \
-extensions v3_leaf


> SIGN THE CSR

Create another file:
!@NetOps
nano linux-ext.cnf

~~~
[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = ftp.rivancorp.com
DNS.2 = rivancorp.com
IP.1  = 192.168.102.10
~~~


!@NetOps
openssl x509 -req \
  -in linux.csr \
  -CA netops-subca.crt \
  -CAkey netops-subca.key \
  -CAcreateserial \
  -out grant-linux.pem \
  -days 365 \
  -extfile linux-ext.cnf \
  -extensions v3_leaf



***************



1. Install lftp

!@NetOps
sudo yum install lftp

2. Access Windows FTP Server

!@NetOps
cd /certs
cat netops-ca.crt netops-subca.crt grant-linux.pem > fullchain.pem
lftp -u administrator [IP ADDRESS]
set ssl:ca-file fullchain.pem
set ftp:ssl-force true
set ftp:ssl-protect-data true

































*******************
S2S VPN Certificates


1. UTM-PH

~~~
!@VPN-PH
conf t
 hostname UTM-PH
 enable secret pass
 service password-encryption
 no logging cons
 no ip domain lookup
 line vty 0 14
  transport input all
  password pass
  login local
  exec-timeout 0 0
 int g1
  ip add 208.8.8.11 255.255.255.0
  no shut
 int g2
  ip add 192.168.102.11 255.255.255.0
  no shut
 int g3
  ip add 11.11.11.113 255.255.255.224
  no shut
 !
 username admin privilege 15 secret pass
 ip http server
 ip http secure-server
 ip http authentication local
 end
wr
~~~



2.  UTM-JP

~~~
@VPN-JP
conf t
 hostname UTM-JP
 enable secret pass
 service password-encryption
 no logging cons
 no ip domain lookup
 line vty 0 14
  transport input all
  password pass
  login local 
  exec-timeout 0 0
 int g1
  ip add 208.8.8.12 255.255.255.0
  no shut
 int g2
  ip add 192.168.102.12 255.255.255.0
  no shut
 int g3
  ip add 21.21.21.213 255.255.255.240
  ip add 22.22.22.223 255.255.255.192 secondary
  no shut
 !
 username admin privilege 15 secret pass
 ip http server
 ip http secure-server
 ip http authentication local
 end
wr
~~~


3. BDLG-PH

~~~
!@BLDG-PH
sudo su
ifconfig eth0 11.11.11.100 netmask 255.255.255.224 up
route add default gw 11.11.11.113
ping 11.11.11.113
~~~


4. BLDG-JP
~~~
@BLDG-JP
sudo su
ifconfig eth0 21.21.21.211 netmask 255.255.255.240 up
route add default gw 21.21.21.213
ping 21.21.21.213
~~~

5. Install the RootCA & SubCA on Cisco Routers

~~~
!@UTM-PH & UTM-JP
conf t
crypto pki trustpoint NETOPS-CA
 enrollment terminal
 revocation-check none
 hash sha256
 exit
crypto pki trustpoint NETOPS-SUBCA
 enrollment terminal
 revocation-check none
 hash sha256
 end
~~~


> INSTALL THE CA

~~~
conf t
 crypto pki authenticate NETOPS-CA
~~~


~~~
conf t
 crypto pki authenticate NETOPS-SUBCA
~~~



5. Create CSR for both UTM Routers

~~~
!@UTM-PH
conf t
 ip domain name utmph.com
 crypto key generate rsa label KEY modulus 2048
 end
~~~


~~~
!@UTM-JP
conf t
 ip domain name utmjp.com
 crypto key generate rsa label KEY modulus 2048
 end
~~~




5. Generate RSA Key Pair on both routers.

~~~
!@UTM-PH, UTM-JP
conf t
 crypto key generate rsa general-keys label rivankeys modulus 2048 exportable
 end
~~~


6.  Generate CSRs

~~~
!@UTM-PH & UTM-JP
conf t
 crypto pki enroll NETOPS-SUBCA
~~~




7. Transfer CSR

~~~
!@NetOps
cd /certs
nano utmph.csr

~~~


~~~
!@NetOps
cd /certs
nano utmjp.csr

~~~


~~~
!@UTM-PH
-----BEGIN CERTIFICATE REQUEST-----
...
-----END CERTIFICATE REQUEST-----
~~~



~~~
!@UTM-JP
-----BEGIN CERTIFICATE REQUEST-----
...
-----END CERTIFICATE REQUEST-----
~~~




~~~
CLIENT - UTM-PH
!@NetOps
nano utm-ph.cnf
~~~


~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_leaf
prompt             = no

[ req_distinguished_name ]
C  = PH
ST = NCR	
L  = Makati
O  = Rivancorp
OU = VPN-PH
CN = vpnph.rivancorp.com

[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1   = vpnph.rivancorp.com
DNS.2   = rivancorp.com
IP.1    = 208.8.8.11
~~~


~~~
!@NetOps
nano utm-jp.cnf
~~~


~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_leaf
prompt             = no

[ req_distinguished_name ]
C  = JP
ST = Tokyo	
L  = Minato
O  = Rivancorp
OU = VPN-JP
CN = vpnjp.rivancorp.com

[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1   = vpnjp.rivancorp.com
DNS.2   = rivancorp.com
IP.1    = 208.8.8.12
~~~




8. Sign the CSRs

Create another file:

~~~
!@NetOps
nano utmph-ext.cnf
~~~


~~~
[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1   = vpnph.rivancorp.com
DNS.2   = rivancorp.com
IP.1    = 208.8.8.11
~~~


~~~
!@NetOps
openssl x509 -req \
  -in utmph.csr \
  -CA netops-subca.crt \
  -CAkey netops-subca.key \
  -CAcreateserial \
  -out grant-utmph.pem \
  -days 365 \
  -extfile utmph-ext.cnf \
  -extensions v3_leaf
~~~



> Create another file:
~~~
!@NetOps
nano utmjp-ext.cnf
~~~


~~~
[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1   = vpnjp.rivancorp.com
DNS.2   = rivancorp.com
IP.1    = 208.8.8.12
~~~


~~~
!@NetOps
openssl x509 -req \
  -in utmjp.csr \
  -CA netops-subca.crt \
  -CAkey netops-subca.key \
  -CAcreateserial \
  -out grant-utmjp.pem \
  -days 365 \
  -extfile utmjp-ext.cnf \
  -extensions v3_leaf
~~~




9. Transfer the Signed Certificate then Import to the Router

~~~
!@NetOps
cat grant-utmph.pem 
~~~


~~~
!@UTM-PH
conf t
crypto pki import NETOPS-SUBCA certificate
~~~


~~~
!@NetOps
cat grant-utmjp.pem 
~~~


~~~
!@UTM-JP
conf t
crypto pki import NETOPS-SUBCA certificate
~~~












10. Configure VPN via Certificate Authentication


> GRE Tunnel
~~~
!@VPN-PH
conf t
 int tun1
  ip add 172.16.10.1 255.255.255.0
  tunnel source g1
  tunnel destination 208.8.8.12
  tunnel mode gre ip
  end
~~~



~~~
!@VPN-JP
conf t
 int tun1
  ip add 172.16.10.2 255.255.255.0
  tunnel source g1
  tunnel destination 208.8.8.11
  tunnel mode gre ip
  end
~~~




> 02. Routing Interesting traffic

~~~
!@VPN-PH
conf t
 ip route 21.21.21.208 255.255.255.240 172.16.10.2
 ip route 22.22.22.192 255.255.255.192 172.16.10.2
 end
~~~



~~~
!@VPN-JP
conf t
 ip route 11.11.11.96 255.255.255.224 172.16.10.1
 end
~~~




> 03. Configure ISAKMP Policy

~~~
!@VPN-PH, VPN-JP
conf t
 crypto isakmp policy 1
  authentication rsa-sig
  encryption aes 256
  hash sha512
  group 14
  end
~~~



> 04. Configure IPSec Profile

~~~
!@VPN-PH, VPN-JP
conf t
 crypto ipsec transform-set IPSECTUNNEL esp-aes 256 esp-sha-hmac
  mode transport
  exit
 crypto ipsec profile RIVAN
  set transform-set IPSECTUNNEL
  set pfs group14
  end
~~~


> 05. Apply IPSec Profile Protection to Tunnel
~~~
!@VPN-PH, VPN-JP
conf t
 int tunnel 1
  tunnel protection ipsec profile RIVAN 
  end
~~~



Verify:
~~~
!@VPN-PH, VPN-JP
show crypto isakmp sa
show crypto ipsec sa
~~~
